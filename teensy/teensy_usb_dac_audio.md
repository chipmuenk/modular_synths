[Back to Teensy](./teensy.md)

<hr>

# USB Audio to Headphone Converter

This example shows how to setup the Codec on the Teensy audio shield to route an audio stream from the USB interface to the CODEC via I2S and pass the analog signal to the headphone output.

The following image shows the schematic of the Teensy audio shield 4.0 rev D by the creator Paul Stoffregen.

<img src="../img/teensy_audio_shield_4_schematic.png" alt="Schematic of the Teensy Audio Shield 4.0 rev. D" width="90%"/>

See https://mnaganov.github.io/2020/10/audio-output-on-teensy-4x-boards.html

https://www.pjrc.com/store/audio_tutorial_kit.html

## Teensy GUI

The data stream is routed on the Teensy from the USB interface to the I2S interface on pins 7, 20, 21 and 23 which is connected to the SG5000 Codec chip (see schematic).

<img src="../img/teensy_gui_usb_dac_audio.png" alt="Teensy GUI: USB to analog output" width="40%"/>

## Code

Except for the `setup()` and `loop()` statements, the code has been generated by and exported from the Teensy Audio System Design Tool.

```C
#include <Audio.h>
#include <Wire.h>
#include <SPI.h>
#include <SD.h>
#include <SerialFlash.h>

const int myInput = AUDIO_INPUT_LINEIN;
// const int myInput = AUDIO_INPUT_MIC;

// GUItool: begin automatically generated code
AudioInputUSB            usb1;
AudioOutputI2S           i2s1;

AudioConnection          patchCord1(usb1, 0, i2s1, 0);
AudioConnection          patchCord2(usb1, 1, i2s1, 1);

AudioControlSGTL5000     sgtl5000_1;
// GUItool: end automatically generated code

void setup() {
// put your setup code here, to run once:
AudioMemory(10);
sgtl5000_1.enable();
sgtl5000_1.volume(0.5);
}
elapsedMillis last_ms = 0;
float last_vol = 0.5;

void loop() {
  if (last_ms > 50) {
  // read the PC's volume setting
  float vol = usb1.volume();

  // scale to a nice range (not too loud)
  // and adjust the audio shield output volume
  if (vol > 0) {
    // scale 0 = 1.0 range to:
    //  0.3 = almost silent
    //  0.8 = really loud
    vol = 0.3 + vol * 0.5;
  }

  // use the scaled volume setting.  Delete this for fixed volume.
  sgtl5000_1.volume(vol);

  last_ms = millis - last_ms;
}
```

## Experiment

Select "Teensy Audio: USB Audio" as the playback device. This is only available when `USB Type: Audio` has been selected during compilation and when a USB sink is used.

You should now be able to use the Teensy with the audio shield like a normal USB sound card.

<hr>

[Back to Teensy](./teensy.md)